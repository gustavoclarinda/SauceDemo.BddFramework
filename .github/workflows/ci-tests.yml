name: CI - SauceDemo BDD Automation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  tests:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run UI tests (SauceDemo.BddFramework)
        run: dotnet test SauceDemo.BddFramework.csproj --configuration Release

      - name: Run API tests (SauceDemo.ApiTests)
        run: dotnet test SauceDemo.ApiTests.csproj --configuration Release
      
      - name: Collect Allure results
        run: |
          mkdir allure-results
          if (Test-Path "SauceDemo.BddFramework/bin/Release/net8.0/allure-results") {
              Copy-Item "SauceDemo.BddFramework/bin/Release/net8.0/allure-results/*" allure-results -Recurse -Force
          }
          if (Test-Path "SauceDemo.ApiTests/bin/Release/net8.0/allure-results") {
              Copy-Item "SauceDemo.ApiTests/bin/Release/net8.0/allure-results/*" allure-results -Recurse -Force
          }

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@v1.7
        with:
          allure_results: allure-results
          allure_report: allure-report
          keep_reports: 10

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
